# Outerbounds Project Deployment for GitLab CI/CD template

stages:
  - deploy

deploy:
  stage: deploy
  image: python:3.12
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

  # OIDC token for secure authentication with Outerbounds.
  # IMPORTANT: The 'aud' value must match your Outerbounds platform URL
  # (the same value as 'platform' in obproject.toml).
  #
  # This cannot be dynamically read from obproject.toml because GitLab
  # evaluates id_tokens at pipeline creation time, before any scripts run.
  # Update this value when setting up a new project.
  id_tokens:
    OUTERBOUNDS_ID_TOKEN:
      aud: https://dev-yellow.outerbounds.xyz

  script:
    - wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 && chmod +x /usr/local/bin/yq
    - PROJECT_NAME=$(yq .project obproject.toml)
    - DEFAULT_CICD_USER="${PROJECT_NAME//_/-}-cicd"
    - PLATFORM=$(yq .platform obproject.toml)
    - CICD_USER=$(yq ".cicd_user // \"$DEFAULT_CICD_USER\"" obproject.toml)
    - PERIMETER="default"
    - |
      echo "üèóÔ∏è Deployment target:"
      echo "  Platform: $PLATFORM"
      echo "  CI/CD User: $CICD_USER"
      echo "  Perimeter: $PERIMETER"

    - python -m pip install -U requests pyyaml toml outerbounds ob-project-utils

    - |
      outerbounds service-principal-configure \
        --name $CICD_USER \
        --deployment-domain $PLATFORM \
        --perimeter $PERIMETER \
        --jwt-token $OUTERBOUNDS_ID_TOKEN

    - obproject-deploy
